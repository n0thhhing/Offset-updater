import * as fs from 'fs';

const isRegExp = (obj: any): obj is RegExp => obj instanceof RegExp;
const hLib = await readHex('libs/new.so');
const patterns: RegExp[] | Pattern[] = [
  /f553bea9f37b01a9..............39f303012af40300aa......................f9......................f9........28008052......39e00314aa......................f9..............b91f01136b........e00314aa......................f9......................f9e103132a020140f9..............................91e1031faa........................00008012........c0035fd6........e923bb6df96301a9f75b02a9f55303a9f37b04a9......................39......f9f40300aa......................f9......................f9......................f9......................f9......................f9......................f9......................f9/g,
  /f553bea9f37b01a9..............39f303012af40300aa......................f9......................f9......................f9......................f9........28008052......39e00314aa..............................f9..............b9e00314aa................bf02136b..............f9......................f9e103132a020140f9......................................f9......f9010140f9..............................91e1031faa..............................f9......f9010140f9................................c0035fd6........ff8302d1f55308a9f37b09a9......................39......f9f30300aa......................f9......../g,
  /fe0f1ff8......................91e1031faa......f8................fe0f1ff8......................f9......f8c0035fd6........f40f1ef8f37b01a9..............39f30300aa......................f9......................f9........28008052......39e00313aa........f403002ae00313aa......................f9..............b9......111f01146b........e00313aa......................f9......................f9e103142a020140f9..............................91e1031faa......f8................e0031f2a......f8c0035fd6........f40f1ef8f37b01a9..............39f30300aa......................f9......................f9........28008052/g,
  /fe0f1ff8......f9e0230091e1031faae80700f9..............f8c0035fd6......f9c0035fd6018c01f8........f60f1df8f55301a9f37b02a9..............39f30301aaf40300aa......................f9........28008052......39..............f9..............f9e2031faa......................f9e0230091e1031faae80700f9..............f9f403002ae0230091e1031faae80700f9........8002004b......................f9......f9c00240f9......b9........................c80240f9e00315aae2031faa......f9......f9..............f9f503002ae0230091e1031faae80700f9..............f9f403002ae0230091e1031faae80700f9........8002221e......................bd/g,
  /ffc300d1f55301a9f37b02a9..............39f30300aa......................f9......................f9........28008052......39ff0700f9......b91f000071........f40313aa..............38......f9........e00313aae1031f2a........a10240f9e00314aa........e00700f9e0230091e1031faa........................ffc30091c0035fd6ffc300d1f55301a9f37b02a9......................39......f9f30300aa......................f9........28008052......39e00313aae1031f2a........820240f9e10300aae0030091ff0b00b9ff0300f9..............b9e90340f9681a00b9690a00f9................ffc30091c0035fd6f553bea9f37b01a9......................39......f9/g,
  /......91e1031faa........ff8304d1fc7300f9f75b0fa9f55310a9f37b11a9................f30308aa......39......f9f403012af503002a......................f9........28008052......39e8830191e003152aff7f0ca9ff6b00f9ff7f0aa9ff5b00f9..............f9......3de183c83c......f9c00240f9e86b00f9e033803de12b803de95b00f9e83b00f9e01b803de113803de92b00f9......b9..............................3d......f9......3d......f9e0030091f6d701a9e003803de80b00f9e183823ce91f00f9................e003142ae1031faa........f50300aa........e0031faa........e103002ae0830191e203142ae3031faaff3300f9..............f9......3d......f9......3d......f9/g,
  /f553bea9f37b01a9..............39f30301aaf40300aa......................f9........28008052......39......f9......................f9......b9200140f9......b9................e10313aa........e003142ae2031faa........................c0035fd6f40f1ef8f37b01a9f303012ae1031faaf40300aa........931200b9..............f8c0035fd6f40f1ef8f37b01a9f303012ae1031faaf40300aa........931200b9..............f8c0035fd6f60f1df8f55301a9f37b02a9......................39......f9f40300aa......................f9......................f9......................f9......................f9........28008052......39600240f9......f9......b9/g,
  /ff4304d1fc6300f9f9630da9f75b0ea9f5530fa9f37b10a9......................39......f9f30300aa......................f9......................f9......................f9......................f9......................f9......................f9......................f9......................f9......................f9........28008052......39800240f9......b9................e00313aa..............................f9200340f9......b9................e0031faa..............................f981158052e2031faa........800240f9......b9................e00313aa........f40300aae063009102158052e1031f2af6630091........21008052/g,
  /f37bbfa9f30300aa......................f9........080040f9........20013fd6........e0031f2a........c0035fd6e00313aa........................fe0f1ff8......f9........080040f9..............f840001fd6........f40f1ef8f37b01a9..............39f30300aa......................f9........28008052......39......f9........080040f9........20013fd61f000071........e00313aa......................f9........080040f9........20013fd6..............f9......................f9......f9e2031faa000140f9........880240f9e20300aa81008052e00314aa........20013fd6......f9........080040f9......................f840001fd6..............f8/g,
  /f553bea9f37b01a9..............39f303012af40300aa......................f9........28008052......39......f9e003132ae1031faa..............................f9........e10300aae00314aa020140f9........................fc0f1cf8f75b01a9f55302a9f37b03a9ffc30ad1......................39......f9f30300aa......................f9......................f9......................f9........28008052......39e083059102158052e1031f2a........800240f9......b9................e0031faa................e1358052e2031faa........e083059102158052e1031f2a........e80c8052c9058052e97301b9e86701b9......f9......................f9......../g,
  /f37bbfa9f30300aa......................b9........................f37bbfa9f30300aa......................b9......................91e1031faa........................ff4301d1fe2300f900e4006fe8030091e00301ade00300ad........e0030091e1031faa..............f9ff430191c0035fd6ff8301d1f55304a9f37b05a9..............39f40300aaf30308aa......................f9......................f9........28008052......39880240f9e00314aa........20013fd6........880240f9e00314aa........20013fd6..............b91f050071........880240f9e00314aa........20013fd6......................f921008052020140f9e8030091......................../g,
  /f40f1ef8f37b01a9..............39f30300aa......................f9......................f9......................f9........28008052......39......................f9000140f9......b9................e0031faa................e10313aa........e2031faa......f8......................f9........000140f9......b9......f9................600240f9e1031faa................e0031f2a......f8c0035fd6........f40f1ef8f37b01a9..............39f30300aa......................f9......................f9......................f9........28008052......39......................f9000140f9......b9................e00313aa................/g,
  /f37bbfa9f30300aa........e103002ae00313aa......................bd........c0035fd6........f37bbfa9f30300aa........e103002ae00313aa................f40f1ef8f37b01a9..............39f30300aa......................f9........28008052......39e00313aa......................f9......................f9010140f9................e1031faa......f8................f40f1ef8f37b01a9..............39f30300aa......................f9........28008052......39e00313aa......................f9......................f9010140f9................e1031faa......f8................ff0301d1f60b00f9f55302a9f37b03a9..............39f30300aa/g,
  /f60f1df8f55301a9f37b02a9......................39......f9f30300aa......................f9......................f9......................f9......................f9........28008052......39e00313aa........c80240f9f30300aa......b9........e00308aa........c80240f9......f9......f9......................b9......f9........e00308aa........c80240f9......f9800240f9150140f9..............................f9e10315aae3031faaf40300aa020140f9........c80240f9e10314aa......f9148c00f8..............................f9e00313aae10314aa........020140f9..............f8................ff8302d1fc2300f9fb6b05a9f96306a9f75b07a9/g,
  /fe0f1ff8........1f000071e0179f1a......f8c0035fd6f60f1df8f55301a9f37b02a9..............39f503022af30301aaf40300aa......................f9........28008052......39........e00314aae10313aa......................................f8c0035fd6..............f9e00314aa........a00240f9......b9................e0031faa..............................b9......f9................e3031faa......f8................f40f1ef8f37b01a9..............39f30300aa......................f9........28008052......39......f9......................f9........010140f9......f8................f60f1df8f55301a9f37b02a9......................39/g,
  /f40f1ef8f37b01a9..............39f30300aa......................f9........28008052......39e00313aa........1f040071......................f9000140f9......b9................e0031faa................e10313aa........e2031faa......f8................e0031f2a......f8c0035fd6........ff8303d1f46300f9f37b0da9..............39f30300aa......................f9........28008052......39680240f9e00313aa......f9......f920013fd6........f30300aa........6082c23c6182c33c6282c53c6382c43cff7f01a9e00701adff0700f9e30b02ad......................f9................e483c03c......f9230140f9e8030291e1030291e2830191e123803d008d00ad/g,
  /f60f1df8f55301a9f37b02a9......................39......f9f303012af40300aa......................f9........28008052......39a00240f9......b9................a00240f9......f9......b9bf02136b........f6031f2a........f6031f2ae00314aae103152a......................91e1031faa..............11bf02136b......0b........................e003162a......f8c0035fd6........f40f1ef8f37b01a9f30300aa........f403002ae00313aa................8802004b007da80a......f8c0035fd6f40f1ef8f37b01a9f30300aa........f403002ae00313aa........e103002ae00313aa................8802004b007da80a......f8c0035fd6f40f1ef8f37b01a9f30300aa......../g,
  /f37bbfa9f30300aa......f9........e1031faa..............................f9........e1031faa................e0179f1a........e0031f2a........c0035fd6........20008052c0035fd6fe0f1ff8......f9........e1031faa................e0d79f1a......f8c0035fd6........fe0f1ff8......f9........e00308aae1031faa......f8........080040f9........20013fd6........e1031faa......f8................f40f1ef8f37b01a9..............39f30300aa......................f9........28008052......39......................f9690240f9080140f9......39......397f010a6b..............f9......8b29815ff83f0108eb..............f9................e1031faa/g,
  /fe0f1ff8......f9........e00308aae1031faa......f8........080040f9........20013fd6........e1031faa......f8................f40f1ef8f37b01a9..............39f30300aa......................f9........28008052......39......................f9690240f9080140f9......39......397f010a6b..............f9......8b29815ff83f0108eb..............f9................e1031faa......f8........680240f9e00313aa........20013fd6................e1031faa......f8................e003271e......f8c0035fd6........e80f1efcf37b01a9080040f9f30300aa........20013fd6......................f9........e1031faa081ca04e........0018281e......../g,
  /f553bea9f37b01a9......................39......f9......................f9......................f9......................f9......................f9........28008052......39800240f9......b9................800240f9......f9......b91f010071..............b9........................800240f9......f9......39......................b9......f9................880240f9......f92900805209710139600240f9..............................f9........e1031faae3031faa020140f9......f9f30300aa........a00240f9......b9................e00313aae1031faa........800240f9......b9................800240f9......f9..............b9......../g,
  /f60f1df8f55301a9f37b02a9..............39f30300aa......................f9......................f9......................f9......................f9........28008052......39e00313aa................e00313aa......................................f9..............39........20008052..............f9..............391f010071e0079f1a........e00313aa..............................f9........c80240f9f30300aa......b9........e00308aa........c80240f9......f9......f9......................b9......f9........e00308aa........c80240f9......f9800240f9150140f9..............................f9e10315aae3031faaf40300aa020140f9/g,
  /ffc300d1f55301a9f37b02a9......................39......f9f303002a......................f9......................f9......................f9......................f9......................f9......................f9......................f9......................f9........28008052......39800240f9ff0700f9......b9................e0031faa..............................f9........a80240f9......f9......f9200140f9......f9......b9................e00314aae1031faae2031faa................a80240f9......f9......f9......................f90a0140f9890240f95f0109eb..............f9......................f9e103132a020140f9/g,
  /f40f1ef8f37b01a9......................39......f9......................f9......................f9........28008052......39600240f9......b9................600240f9......f9......f9......................f92a0140f9690140f9......39......399f010b6b..............f9......8b4a815ff85f0109eb................e0031f2a......f8c0035fd6......b9................680240f9......f9......f9................e1031faa......f8................f40f1ef8f37b01a9......................39......f9......................f9......................f9........28008052......39600240f9......b9................600240f9......f9......f9......../g,
  /1fa00071........e803002a290080522821c89a890680d26901a2f24922c0f21f0109ea........20008052c0035fd61f9c0071e8179f1a1fb00071e9179f1a0001092ac0035fd6f40f1ef8f37b01a9......................39......f9......................f9........28008052......39600240f9......b9..............................39......................f9........28008052......39600240f9......b9................600240f9......f9......b91f110071..............b9......................39......................f9........28008052......39600240f9......b9................600240f9......f9......b91f090071........e0031f2a..............b9................/g,
  /f40f1ef8f37b01a9......................39......f9......................f9......................f9........28008052......39600240f9......b9................600240f9......f9......39......................f9600240f9......b9..............................39......................f9........28008052......39600240f9......b9................600240f9......f9......b9090900513f9d0071........aa0198d24a80b0f28a08c0f24925c99a........1f9d0071e9179f1a1fb10071e8179f1a2001082a........e0031f2a........20008052..............f8c0035fd6f40f1ef8f37b01a9......................39......f9......................f9........28008052/g,
  /ff8303d1ef3b046ded33056deb2b066de923076dfc6f08a9fa6709a9f85f0aa9f6570ba9f44f0ca9fd7b0da9......................39......f9f403062afd0305aa681ca34e491ca24e2a1ca14ef903042afa03032afb03022af803012a0b1ca04ef30300aa......................f9......................f9......................f9......................f9......................f9......................f9......................f9......................f9......................f9......................f9......................f9......................f9......................f9......................f9......................f9......................f9......../g,
  /e923bc6df60b00f9f55302a9f37b03a9......................39......f9f30300aa......................f9......................f9........28008052......39f50313aa......f8c00240f9..............b9......f9................e0031faa........e10300aaa00200f9e00315aa........c00240f9......b9................e0031faa................e0031faa........e10300aaa00200f9e00315aa..............f9........e1031faa..............39e00313aa081ca04e..............39........e00313aa7f320239........e00313aa........e00313aa........e00313aa091ca04e........................e00313aa........................e00313aa7f320239140c05f8e10314aa/g,
  /f80f1cf8f75b01a9f55302a9f37b03a9..............39f40301aaf30300aa......................f9......................f9......................f9......................f9......................f9......................f9......................f9......................f9......................f9......................f9......................f9......................f9........28008052......39......39..............39..............f9......................f9e1031faa........e80240f9f50300aa......b9........e00308aa........e00315aae1031faae2031faa......................f9........e1031faa......................39......../g,
  /ee0f19fcedb3006debab016de9a3026df81f00f9f75b04a9f55305a9f37b06a9..............39f40301aaf30300aa......................f9......................f9......................f9......................f9......................f9......................f9......................f9......................f9......................f9......................f9......................f9......................f9......................f9......................f9........28008052......397f060839........e00314aae1031faa..............................f9e2031faa010140f9........08102e1e..............39..............39..............39/g,
  /f40f1ef8f37b01a9......................39......f9......................f9........28008052......39600240f9......b9................600240f9......f9........e1031faa......91......f8........ffc300d1f55301a9f37b02a9......................39......f9f303002a......................f9........28008052......39e0031faa........e103002ae0230091e203132ae3031faaff0700f9........800240f9......b9................800240f9......f9......f9096100f9................ffc30091c0035fd6f553bea9f37b01a9......................39......f9......................f9......................f9........28008052......39a80240f9......b9......../g,
  /f553bea9f37b01a9......................39......f9f30300aa......................f9......................f9......................f9......................f9........28008052......39a00240f9......b9................e0031faa..............................f9........a00240f9......b9......f9................a00240f9......f9810240f9e2031faa......f9......................b9......................f9000140f9......b9................e0031faa................81048052e2031faa..............3908010052......0b................c0035fd6........ff4306d1fca300f9f96315a9f75b16a9f55317a9f37b18a9..............39f30300aa......../g,
  /f40f1ef8f37b01a9..............39f30300aa......................f9......................f9........28008052......39e00313aa..............................f9000140f9......b9................e0031faa..............................f9000140f9......b9................e0031faa......................b9e2031faa......................b9..............f8c0035fd6e00313aa..............f8................f553bea9f37b01a9......................39......f9f30300aa......................f9......................f9........28008052......39a00240f9......b9................e0031faa..............................f9......f9020140f9/g,
  /f60f1df8f55301a9f37b02a9..............39f30300aa......................f9......................f9......................f9........28008052......39e0031faa..............b91f01006b..............b9......................f9f503002ae00313aa7f7e0fa9........c30240f9f403002ae0230091e103152ae203142aff0700f9..............f9685200f9e003142a......................f8c0035fd6f40f1ef8f37b01a9..............39f30300aa......................f9......................f9........28008052......39e00313aa..............................f9000140f9......b9................e0031faa..............................f9000140f9......b9/g,
  /f553bea9f37b01a9..............39f403012af30300aa......................f9........28008052......39......f9......................f9e103142a020140f9........1f0000720804805209038052..............b8................c0035fd6........ff0303d1fc6f06a9fa6707a9f85f08a9f65709a9f44f0aa9fd7b0ba9..............39f40301aaf30300aae10b05a9......................f9......................f9......................f9......................f9......................f9......................f9......................f9......................f9......................f9......................f9......................f9................/g,
  /ff8300d1f37b01a9..............39......................f9......................f9........28008052......39......................................f9......................f9......91e1031faa........620240f9e103002ae0230091ff0700f9..............b9........e0031f2a........ff830091c0035fd6........ffc307d1fc6f19a9fa671aa9f85f1ba9f6571ca9f44f1da9fd7b1ea9..............39f30302aaf40301aaf60300aa......................f9......................f9......................f9......................f9......................f9......................f9......................f9......................f9......................f9/g,
  /ff0301d1f75b01a9f55302a9f37b03a9......................39......f9f403022af503012af30300aa......................f9......................f9......................f9......................f9......................f9......................f9......................f9......................f9........28008052......39c00240f9ff0700f9..............................f9e1031faaf60300aa........d5520229e00240f9......b9................e003152ae103142a..............................f9f403002a......f9000140f9..............................f9........e10316aae3031faa020140f9......f9f50300aa........e20240f9e00313aae10315aa/g,
  /f60f1df8f55301a9f37b02a9......................39......f9f303012af403002a......................f9......................f9......................f9........28008052......39a00240f9..............b9......f9................e003142ae103132a........a80240f9f30300aa......b9........e00308aa........e0031faa..............................f9e20313aa................030140f9a1158052......f8................ff0301d1f75b01a9f55302a9f37b03a9......................39......f9f403022af503012af30300aa......................f9......................f9......................f9......................f9......................f9/g,
  /ff0301d1f75b01a9f55302a9f37b03a9......................39......f9f403022af503012af30300aa......................f9......................f9......................f9......................f9......................f9......................f9......................f9......................f9........28008052......39c00240f9ff0700f9..............................f9e1031faaf60300aa........d5520229e00240f9......b9................e003152ae103142a..............................f9f403002a......f9000140f9..............................f9........e10316aae3031faa020140f9......f9f50300aa........e20240f9e00313aae10315aa/g,
  /f75bbda9f55301a9f37b02a9......................39......f9f30300aa......................f9......................f9......................f9......................f9........28008052......39800240f9......b9..............................39......................f9........28008052......39800240f9......b9................800240f9......f9......39........f4031f2ae003142a........................c0035fd6..............f9000140f9......b9................e0031faa......................f9..............b91f050071......................f9f4031f2af6031f2ae20240f9e00315aae103162a................e20240f9e00315aae103162a/g,
];

async function readHex(filePath: FilePath): Promise<Hex> {
  const start: Time = Bun.nanoseconds();
  try {
    const data: Buffer = await fs.promises.readFile(filePath);
    const hexString: Hex = data.toString('hex');
    const end: Time = Bun.nanoseconds();
    console.log(`readHex(${filePath}) ${(end - start) / 1_000_000}`);
    return hexString;
  } catch (err) {
    throw err;
  }
}

const processPattern = (pattern: Pattern): RegExp => {
  const start: Time = Bun.nanoseconds();
  const newPattern: RegExp = new RegExp(
    pattern
      .replace(/\s+|\?/g, (char) => (char === '?' ? '.' : ''))
      .toLowerCase(),
    'g',
  );
  console.log('processPattern:', (Bun.nanoseconds() - start) / 1_000_000);
  return newPattern;
};

function scan(pattern: RegExp | Pattern, hexString: Hex): Offset[] {
  const start: Time = Bun.nanoseconds();
  if (!isRegExp(pattern)) pattern = processPattern(pattern);
  const matchesIndexes: number[] = [];
  let match;
  while ((match = pattern.exec(hexString)) !== null) {
    matchesIndexes.push(match.index / 2);
  }
  const end: Time = Bun.nanoseconds();
  console.log('scan()', (end - start) / 1_000_000);
  return matchesIndexes;
}

for (const pattern of patterns) {
  const start: Time = Bun.nanoseconds();
  const matches: string[] = scan(pattern, hLib).map(
    (index: number) => `0x${index.toString(16)}`,
  );
  console.log(
    'Pattern found at positions:',
    matches,
    (Bun.nanoseconds() - start) / 1_000_000,
  );
}
